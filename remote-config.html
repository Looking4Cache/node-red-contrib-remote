<script type="text/javascript">
  RED.nodes.registerType('remote-config',{
    category: 'config',
    color: '#C0DEED',
    defaults: {
      name: {value:"Node-RED UI"},
      host: {value:"localhost"},
      port: {value:1880, validate:RED.validators.number()},
      baseurl: {value:"/ui"},
      instancehash: {value:""},
      server: {value:""}
    },
    credentials: {
      instanceauth: {type:"text"}
    },
    internalIpV4: '',
    oneditprepare: function() {
        document.getElementById('node-config-input-instancehash').disabled = true;
        document.getElementById('node-config-input-instanceauth').disabled = true;
        document.getElementById('node-config-input-server').disabled = true;
        document.getElementById('remoteInstanceInputs').style.visibility = 'collapse';

        $.getJSON('contrib-remote/internalIpV4',function(data) {
          internalIpV4 = data.ipv4;
          updateLocalhostInfo();

          document.getElementById('node-config-input-host').onchange = function() {
            updateLocalhostInfo();
          };
        });

    },
    label: function() {
        return this.name;
    }
  });

  function updateLocalhostInfo() {
    // Gives infos about localhost, maybe hides it.
    if (document.getElementById('node-config-input-host').value.toLowerCase() == 'localhost') {
      document.getElementById('localhostInfo').style.visibility = 'visible';
      document.getElementById('localhostInfo').style.height = '20px';
      document.getElementById('localhostInfo').innerHTML = ` localhost = Host of Node-RED, ${internalIpV4} for internal use`;
    } else {
      document.getElementById('localhostInfo').style.visibility = 'collapse';
      document.getElementById('localhostInfo').style.height = '0px';
    }
  }

  function registerInstance() {
    // Request InstanceHash when empty
    $.getJSON('contrib-remote/requestInstanceHash',function(data) {
      if ( data.error == undefined ) {
        // Fill UI
        document.getElementById('node-config-input-instancehash').value = data.instancehash;
        document.getElementById('node-config-input-instanceauth').value = data.instanceauth;
        document.getElementById('node-config-input-server').value = data.server;
      } else {
        // Show error
        alert('registerInstance: ' + data.error);
      }

      // Next step
      registerApp()
    });
  }

  function registerApp() {
    // Request app register QR code
    const instancehash = document.getElementById('node-config-input-instancehash').value;
    const instanceauth = document.getElementById('node-config-input-instanceauth').value;
    const server = document.getElementById('node-config-input-server').value;
    const name = document.getElementById('node-config-input-name').value;
    const host = document.getElementById('node-config-input-host').value;
    const localport = document.getElementById('node-config-input-port').value;
    const baseurl = document.getElementById('node-config-input-baseurl').value;

    // $.getJSON(`contrib-remote/registerApp/${instancehash}/${instanceauth}/${server}/${encodeURIComponent(name)}`,function(data) {
    const data = {
      'instancehash': instancehash,
      'instanceauth': instanceauth,
      'server': server,
      'name': name,
      'host': host,
      'localport': localport,
      'baseurl': baseurl
    }
    $.post(`contrib-remote/registerApp`, data, function(data) {
      if ( data.error == undefined ) {
        // Show QR Code
        document.getElementById('registerRemoteAppQRCode').src = data.qrcode;
      } else {
        // Show error
        alert('registerApp: ' + data.error);
      }

      // Enable button
      document.getElementById('registerRemoteAppButton').disabled = false;
    });
  }

  function registerButtonClicked() {
    // Disable Button
    document.getElementById('registerRemoteAppButton').disabled = true;

    // Get InstanceHash from UI
    var instanceHash = document.getElementById('node-config-input-instancehash').value;

    // Request InstanceHash when empty
    if ( instanceHash === undefined || instanceHash === '' ) {
      registerInstance();
    } else {
      // Register app
      registerApp();
    }
  }
</script>

<script type="text/html" data-template-name="remote-config">
  <div class="form-row">
    <label for="node-config-input-name"><i class="fa fa-tag"></i> Name</label>
    <input type="text" id="node-config-input-name" placeholder="Name">
  </div>
  <label><i class="fa fa-info-circle"></i> This name will be displayed in the app.</label>
  <br>

  <div class="form-row">
    <label for="node-config-input-host"><i class="fa fa-tag"></i> Serving Host</label>
    <input type="text" id="node-config-input-host" placeholder="">
  </div>
  <label id='localhostInfo'><i class="fa fa-info-circle"></i> localhost = Host of Node-RED</label>
  <br>

  <div class="form-row">
    <label for="node-config-input-port"><i class="fa fa-tag"></i> Serving Port</label>
    <input type="text" id="node-config-input-port" placeholder="">
  </div>
  <div class="form-row">
    <label for="node-config-input-baseurl"><i class="fa fa-tag"></i> Base URL</label>
    <input type="text" id="node-config-input-baseurl" placeholder="">
  </div>

  <br>
  <button id="registerRemoteAppButton" type="button" class="red-ui-button" onclick="registerButtonClicked()">Register Remote App</button>
  <br>

  <img id="registerRemoteAppQRCode" src=""></img>

  <div id="remoteInstanceInputs">
    <div class="form-row">
      <label for="node-config-input-instancehash"><i class="fa fa-tag"></i> Instance</label>
      <input type="text" id="node-config-input-instancehash" placeholder="Wird automatisch berechnet.">
    </div>
    <div class="form-row">
      <label for="node-config-input-instanceauth"><i class="fa fa-tag"></i> Authentication</label>
      <input type="text" id="node-config-input-instanceauth" placeholder="Wird automatisch berechnet.">
    </div>
    <div class="form-row">
      <label for="node-config-input-server"><i class="fa fa-tag"></i> Server</label>
      <input type="text" id="node-config-input-server" placeholder="Wird automatisch berechnet.">
    </div>
  </div>
</script>
